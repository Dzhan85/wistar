
{% extends "base.html" %}
{% block title %}Wistar - Lab Rat - Edit Topology {% endblock %}
{% load staticfiles %}
{% block scripts %}
    <script type="text/javascript" src="{% static "js/shifty.js" %}"></script>
    <script type="text/javascript" src="{% static "js/raphael.js" %}"></script>
    <script type="text/javascript" src="{% static "js/jquery-1.8.1.min.js" %}"></script>
    <script type="text/javascript" src="{% static "js/jquery-ui-1.8.23.custom.min.js" %}"></script>
    <script type="text/javascript" src="{% static "js/jquery.layout.js" %}"></script>
    <script type="text/javascript" src="{% static "js/jquery.autoresize.js" %}"></script>
    <script type="text/javascript" src="{% static "js/jquery-touch_punch.js" %}"></script>
    <script type="text/javascript" src="{% static "js/jquery.contextmenu.js" %}"></script>
    <script type="text/javascript" src="{% static "js/rgbcolor.js" %}"></script>
    <script type="text/javascript" src="{% static "js/canvg.js" %}"></script>
    <script type="text/javascript" src="{% static "js/Class.js" %}"></script>
    <script type="text/javascript" src="{% static "js/json2.js" %}"></script>
    <script type="text/javascript" src="{% static "js/draw2d.js" %}"></script>
    
    <script type="text/javascript" src="{% static "js/topologyIcon.js" %}"></script>
    <script type="text/javascript" src="{% static "js/cloudIcon.js" %}"></script>
    <script type="text/javascript" src="{% static "js/topologySelectionListener.js" %}"></script>
    
    <script type="text/javascript" src="{% static "js/wistar_utils.js" %}"></script>
  
    <!-- <script type="text/javascript" src="{% static "js/prototype.js" %}"></script> -->
   
    <script type="text/javascript">
    var canvas;
    var lastX = 0;
    var lastY = 0;

    var vmxCount = 1;
    var instanceArray = []

    var externalCloudAdded = false;

    var internalCloudCounter = 0;

    // loads initial topology from json stoped in the 'json' div
    // also creates the instance array variable on page context    
    function loadTopology() {
        var test = jQuery('#json').val();
    	if (test != null) {
		    // var jsonTxt = JSON.stringify(test, null, 2);
		    var json = eval(test);
		    reader = new draw2d.io.json.Reader();
		    reader.unmarshal(canvas, json);
		    for(i=0;i<json.length;i++) {
			    if (json[i]["type"] == "draw2d.shape.node.topologyIcon") {
				    vmxCount++;
				    instanceArray.push({ 
                        "label" : json[i]["userData"]["label"], 
                        "type" : json[i]["userData"]["type"], 
                        "state" : "down",
                        "id"    : json[i]["id"]
                    });
			    }
		    }
    	}
    } 

    // iterate instanceArray and grab the latest boot up state for each
    // this runs silently
    function updateAllBootState() {
        console.log("updating boot up state for topology");
        for(v=0;v<instanceArray.length;v++) {
            var instance = instanceArray[v];
            if (instance["type"] == "junos_vmx" || instance["type"] == "junos_firefly" || instance["type"] == "linux") {
                updateBootState(instance["id"], instance["label"]);
            }
        }
    }

    // boot everything!
    function startTopology() {

        var delay = instanceArray.length * 180 / 60;
        var r = confirm("Are you sure you want to power on all Instances? This will take approximately " + delay + " minutes!");
        if (r == false) {
            return r;
        }

        var url = "/ajax/startTopology/"
        var params = {
            'topologyId' : "{{ topo.id }}"
        };
        var successMessage = "All Instances powered on!";

        simpleAjaxRequest(url, params, successMessage); 
    }

    // get instance var form instance array by label
    function getInstanceByLabel(label) {
        for(v=0;v<instanceArray.length;v++) {
            var instance = instanceArray[v];
            if (instance["label"] == "label") {
                return instance;
            }
        } 
    }

    // silently updates the boot state of an instance
    function updateBootState(id, label) {
        domain = generateDomainNameFromLabel(label);
        var figure = canvas.getFigure(id);
        var type = figure.getType();

        var url = "/ajax/getJunosStartupState/";
        
        if (type == "linux") {
            url = "/ajax/getLinuxStartupState/";
        } 
        var params = {
            'name' : domain
        };

        var success = function(response) {
            data = eval(response);
            var state = "down";
            if (data["result"] == false) {
                state = "down";
            } else {
                state = "up";
            }
            console.log("setting state to: " + state);
            topo_object = canvas.getFigure(id);
            topo_object.setBootState(state);
        };

        jQuery.post(url, params, success);
    }

    // used when a new instance is added to the topology
    // convenience func to increment the previously entered ip by 1
    // as wistar currently only supports a /24 for mgmt access
    // there is no need to account for wrapping beyond 255
    function incrementIconIp(ip)  {
        var iparray = ip.split('.');
        if(iparray.length == 4) {
            var last = parseInt(iparray[3]);
            if(! isNaN(last)) {
                return iparray[0] + "." + iparray[1] + "." + iparray[2] + "." + (last + 1);
            } else { 
                return ip;
            }
        } else {
            return ip;
        }
    }

    // convenience func to increment icon name is it happens to end
    // in a digit
    function incrementIconName(name) {
        var last = name.substr(-1);
        var lastInt = parseInt(last);
        if (last == "9") {
            var lastTwo = name.substr(-2);
            var lastTwoInt = parseInt(lastTwo);
            if (! isNaN(lastTwoInt)) {
                return name.substring(0, name.length -2) + (lastTwoInt + 1);
            } else {
                // last two are not an int, check for single digit suffix
                if (! isNaN(lastInt)) {
                    return name.substring(0, name.length -1) + (lastInt + 1);
                } else {
                    return name;
                }
            }
        } else {
            if (! isNaN(lastInt)) {
                return name.substring(0, name.length -1) + (lastInt + 1);
            } else {
                return name;
            }
        }
    }

    // add icon to the topology with the indicated values
    function addIcon() {
    	var ip = jQuery('#topoIconIp').val();
    	var pw = jQuery('#topoIconPass').val();
    	var name = jQuery('#topoIconName').val();
    	var type = jQuery('#topoIconType').val();
    	var image = jQuery('#topoIconImage').val();
    	var cpu = jQuery('#topoIconCpu').val();
    	var ram = jQuery('#topoIconRam').val();
    	var iconData = jQuery('#topoIconIcon').val();
       
        if (ip == "") {
            alert("Please add a valid IP address");
            return;
        } 

        if (name == "") {
            alert("Please add a valid instance name");
            return;
        } 
 
        var icon = iconData.split(":")[0]; 
        var width = iconData.split(":")[1]; 
        var height = iconData.split(":")[2]; 
        var iconPath = "/static/images/" + icon + ".png";
        
    	var canvas_object = new draw2d.shape.node.topologyIcon(iconPath, width, height);
        canvas_object.setup(type, name, ip, pw, image, cpu, ram);
    	lastX += 50;
    	lastY += 50;
    	vmxCount += 1;
	    canvas.addFigure(canvas_object, lastX, lastY);

        // let's try to increment everything nicely
    	jQuery('#topoIconIp').val(incrementIconIp(ip));
    	jQuery('#topoIconName').val(incrementIconName(name));
    }

    // export topology as JSON and stuff it back in the
    // json div element for later retrieval and storage
    function exportJson() {
        // Create a JSON writer and convert it into a JSON-String representation.
        
    	var writer = new draw2d.io.json.Writer();
        var json = writer.marshal(canvas);

        // convert the json object into string representation
        var jsonTxt = JSON.stringify(json, null, 2);

        // insert the json string into a DIV for preview or post
        // it via ajax to the server....
        jQuery("#json").val(jsonTxt);
    }

    // export and submit form 
    function updateTopology() {
        alert('You may need to redeploy this topology after this update!');
	    exportJson();
	    jQuery('#topoForm').submit();
    }

    // export and submit form 
    function saveTopology() {
	    exportJson();
	    jQuery('#topoForm').submit();
    }

    // simple validation
    function createConfigSet() {
        var r = confirm("Snapshot configs of all running instances?");
        if (r == true) {
            jQuery('#configSetForm').submit();
        }
    }

    // simple validation
    function cloneTopology() {
        if(confirm("Are you sure you want to clone this topology?")) {
		    window.location="/topologies/clone/{{ topo.id }}";
	    }
    }

    // simple validation
    function multiCloneTopology() {
        var num_clones = prompt("How many copies would you like to create?");
        if (num_clones == null) {
            alert('very well');
            return false;
        }

        var url = "/ajax/multiCloneTopology/"
        var params = {
            'topologyId' : "{{ topo.id }}",
            'clones' : num_clones
        };
        var successMessage = "Topology Clone Complete!";

        simpleAjaxRequest(url, params, successMessage);
    }

    // simple validation
    function deleteTopology() {
        if(confirm("Are you sure you want to delete this topology?")) {
		    window.location="/topologies/delete/{{ topo.id }}";
	    }
    }

    // simple validation against Junos password rules
    function checkPass(pw) {
        if(pw != "") {
            upper = pw.match('[A-Z]');
            lower = pw.match('[a-z]');
            digit = pw.match('[0-9]');

            if (upper && lower && digit) {
                console.log('password accepted');
            } else {
                alert('Password does not meet complexity requirements');
            }
        } else {
                alert('Password is required');
        }

    }

    // breaks up image type string into data members and sets on the icon
    function setImageType() {
        id = jQuery('#topoIconImageSelect').val().split(':')[0]
        type = jQuery('#topoIconImageSelect').val().split(':')[1]
        console.log("Setting image to " + id + " and type to " + type);
        jQuery('#topoIconType').val(type);
        jQuery('#topoIconImage').val(id);
    }

    // get the name that was used to create the vm instance
    // these use a very simple method to ensure some amount
    // of uniqueness within the hypervisor
    function generateDomainNameFromLabel(name) {
        if ( "{{ topo.id }}" == "" ) {
            alert('Topology not yet deployed');
        }
        return "t{{ topo.id }}_" + name;
    }

    // grab the relevant information from the currently
    // selected topology icon and create an ajax request
    // that will configure device access in the background
    function configureInstanceAccess(quiet) {

        if (typeof quiet == 'undefined') {
            quiet = false;
        }

        var doc = document.getElementsByTagName('html')[0];
        doc.style.cursor = 'progress';

        var figureId = jQuery('#selectedObject').val();
        var figure = canvas.getFigure(figureId);

        if (figure.getBootState() != "up") {
            if (! quiet) {
                alert("Instance must be booted up before access can be configured!");
            } else {
                console.log("instance is not booted up!");
            }
            return false;
        }
        
        var label = figure.getLabel();
        var ip = figure.getIp();
        var password = figure.getPassword();
        var mgmtInterface = figure.getMgmtInterface();
        
        // default url for junos devices 
        var url = "/ajax/preconfigJunosDomain/";

        domain = generateDomainNameFromLabel(label);
        // special case for firefly 
        if (figure.getType() == "junos_firefly") {
            url = "/ajax/preconfigFirefly/";
        } else if (figure.getType() == "linux") {
            url = "/ajax/preconfigLinuxDomain/";
        }

        var params = {
                'domain' : domain,
                'hostname' : label,
                'ip' : ip,
                'password' : password,
                'mgmtInterface' : mgmtInterface
        };

        var success = function(response) {
            data = eval(response);
            var message = "Could not configure access";
            if (data["result"] == true) {
                message = "Success";
            }
            if (! quiet) {
                alert(message);
            }
        };

        var post = jQuery.post(url, params, success);

        post.always(function() {
            doc.style.cursor = '';
        });
    }

    function configureJunosInterfaces() {
        var doc = document.getElementsByTagName('html')[0];
        doc.style.cursor = 'progress';
        
        var figureId = jQuery('#selectedObject').val();
        var figure = canvas.getFigure(figureId);

        if (figure.getBootState() != "up") {
            alert("Instance must be booted up before interfaces can be configured!");
            return false;
        }
        
        var ip = figure.getIp();
        var password = figure.getPassword();
        var url = "/ajax/configJunosInterfaces/";
        var params = {
            'ip' : ip,
            'password' : password
        };
        
        var success = function(response) {
            data = eval(response);
            var message = "Could not configure access";
            if (data["result"] == true) {
                message = "Success";
            }
            alert(message);
        };
        var post = jQuery.post(url, params, success);
        
        post.always(function() {
            doc.style.cursor = '';
        });
    }

   function loadConfigTemplates(topoId) {
        var doc = jQuery(document);
        doc.css('cursor' , 'progress' );

        var figureId = jQuery('#selectedObject').val();
        var figure = canvas.getFigure(figureId);

        if (figure.getBootState() != "up") {
            alert("Instance must be booted up before interfaces can be configured!");
            return false;
        }

        var ip = figure.getIp();

        var cso = jQuery('<div/>').attr("id", "configTemplatesOverlay").addClass("screen-overlay");

        jQuery('#content').append(cso);

        var url = '/ajax/getConfigTemplates/';
        var params = {
            'ip' : ip
        };
        var post = jQuery.post(url, params, function(response) {
            var content = jQuery(response);
            cso.append(content);
        });
        post.fail(function() {
            alert('Could not perform request!');
        });
        post.always(function() {
            doc.css('cursor' , '');
        });
    }
    
    function applyConfigurationTemplate(template_id) {
        
        var doc = document.getElementsByTagName('html')[0];
        doc.style.cursor = 'progress';
 
        var figureId = jQuery('#selectedObject').val();
        var figure = canvas.getFigure(figureId);

        var ip = figure.getIp();
        var password = figure.getPassword();

        var url = "/ajax/applyConfigTemplate/"
        var params = {
            'id' : template_id,
            'ip' : ip,
            'password' : password
        };
        
        var successMessage = "Config Template Applied!";
        var post = jQuery.post(url, params, function(response) {
            var data = eval(response);
            if(data["result"] == "true") {
                alert(successMessage);
            } else {
                console.log(data);
                alert(data["message"]);
            }
        });
        post.fail(function() {
            alert('Could not perform request!');
        });
        post.always(function() {
            doc.style.cursor = '';
            var cto = jQuery('#configTemplatesOverlay');
            cto.empty();
            cto.removeClass("screen-overlay");
        });
    }

    function pushConfigSet(configSetId) {
        var url = "/ajax/pushConfigSet/"
        var params = {
            'id' : configSetId
        };
        var successMessage = "Config Set Push Complete!";
        
        simpleAjaxRequest(url, params, successMessage);
    }

    function deleteConfigSet(configSetId) {
        var url = "/ajax/deleteConfigSet/"
        var params = {
            'id' : configSetId
        };
        var successMessage = "Config Set Deleted";
        
        simpleAjaxRequest(url, params, successMessage);
        location.reload();
    }

    function preconfigFirefly(label, password, mgmtInterface) {
        domain = generateDomainNameFromLabel(label);
        var url = "/ajax/preconfigFirefly/";
        var params = {
            'domain' : domain,
            'password' : password,
            'mgmtInterface' : mgmtInterface 
        };
        var successMessage = "Success!";
        
        simpleAjaxRequest(url, params, successMessage);
    }

    function configDeviceInterfaces(ip, password) {
        var url = "/ajax/configJunosInterfaces/";
        var params = {
            'ip' : ip,
            'password' : password
        };
        var successMessage = "Success!";
        
        simpleAjaxRequest(url, params, successMessage);
    }

    // fixme - do something useful with this data!
    function getJunosConfig(ip, password) {
        
        var url = "/ajax/getJunosConfig/";
        var params = {
            'ip' : ip,
            'password' : password
        };
        var successMessage = "Success!";
        
        simpleAjaxRequest(url, params, successMessage);
        
    }

    function syncLinkData() {

        if (! confirm("Are you sure you want to send this information to the VMs?")) {
            return false;
        }

        // connection should have just been saved.
        // export from the canvas again
        exportJson();

        var params = { 
            'sourceIp' : jQuery('#connectionSourceIp').val(),
            'sourceType' : jQuery('#connectionSourceType').val(),
            'sourceIface' : jQuery('#connectionSourceIface').val(),
            'targetIp' : jQuery('#connectionTargetIp').val(),
            'targetType' : jQuery('#connectionTargetType').val(),
            'targetIface' : jQuery('#connectionTargetIface').val(),
            'sourcePortIp' : jQuery('#connectionSourcePortIp').val(),
            'targetPortIp' : jQuery('#connectionTargetPortIp').val(),
            'sourcePw' : jQuery('#connectionSourcePw').val(),
            'targetPw' : jQuery('#connectionTargetPw').val(),
            'json'  :  jQuery("#json").val(),
            'topologyId'  :  "{{ topo.id }}"
        };
        var url = "/ajax/syncLinkData/";
        var successMessage = "Successfully pushed IP addresses to VMs";

        simpleAjaxRequest(url, params, successMessage);
    }

    function deployTopology() {
        var doc = document.getElementsByTagName('html')[0];
        doc.style.cursor = 'progress';

       var url = '/ajax/deployTopology/';
        var params = {
            'topologyId' : '{{ topo.id }}'
        };
        var post = jQuery.post(url, params, function(response) {
            var content = jQuery(response);
            jQuery('#deploymentStatus').empty().append(content);
        });
        post.fail(function() {
            alert('Could not perform request!');
        });
        post.always(function() {
            doc.style.cursor = '';
        });
    }

    function simpleAjaxRequest(url, params, successMessage) {
        var doc = document.getElementsByTagName('html')[0];
        doc.style.cursor = 'progress';

        var post = jQuery.post(url, params, function(response) {
            data = eval(response);
            if (data["result"] == false) {
                if(data["message"] != undefined) {
                    alert(data['message']);
                } else {
                    alert('Could not complete request');
                }
            } else {
                    alert(successMessage);
            }
        });
        post.fail(function() {
            alert('Could not perform request!');
        });

        post.always(function() {
            doc.style.cursor = '';
        });  
    }

    function getInstanceStartupState() {

        console.log('getting boot up state');
        var figureId = jQuery('#selectedObject').val();
        var figure = canvas.getFigure(figureId);
        var label = figure.getLabel();
        var type = figure.getType();
 
        domain = generateDomainNameFromLabel(label);
        
        var doc = document.getElementsByTagName('html')[0];
        doc.style.cursor = 'progress';
  
        var url = "/ajax/getJunosStartupState/";

        if (type == "linux") { 
            url = "/ajax/getLinuxStartupState/";
        }

        var params = {
            "name" : domain
        };

        var post = jQuery.post(url, params, function(response) {
            data = eval(response);
            if (data["result"] == false) {
                figure.setBootState("down");
                alert('Device is not yet booted up!');
            } else {
                figure.setBootState("up");
                alert('Device is booted and ready!');
            }
        });
        post.fail(function() {
            alert('Could not perform request!');
        });

        post.always(function() {
            doc.style.cursor = '';
        });  
        console.log('getting boot up state');
    }

    function getJunosStartupState() {

        console.log('getting boot up state');
        var figureId = jQuery('#selectedObject').val();
        var figure = canvas.getFigure(figureId);
        var label = figure.getLabel();
        
        domain = generateDomainNameFromLabel(label);
        
        var doc = document.getElementsByTagName('html')[0];
        doc.style.cursor = 'progress';
   
        var url = "/ajax/getJunosStartupState/";
        var params = {
            "name" : domain
        };

        var post = jQuery.post(url, params, function(response) {
            data = eval(response);
            if (data["result"] == false) {
                figure.setBootState("down");
                alert('Device is not yet booted up!');
            } else {
                figure.setBootState("up");
                alert('Device is booted and ready!');
            }
        });
        post.fail(function() {
            alert('Could not perform request!');
        });

        post.always(function() {
            doc.style.cursor = '';
        });  
        console.log('getting boot up state');
    }

    function executeCli() {
        var ip = jQuery('#junosIconIp').val();
        var pw = jQuery('#junosIconPass').val();
        var cli = jQuery('#cli').val();

        var doc = document.getElementsByTagName('html')[0];
        doc.style.cursor = 'progress';
        
        var url = '/ajax/executeCli/';
        var params = {
             'pw' : pw,
             'ip' : ip,
             'cli' : cli
        };
        var post = jQuery.post(url, params, function(response) {
            data = eval(response);
            if (data["result"] == false) {
                alert("Device is not yet booted up!");
                jQuery('#cliOutput').val('error');
                jQuery('#cliOutput').css("height", '');
            } else {
                jQuery('#cliOutput').val(data['output']);
                jQuery('#cliOutput').css("height", '300px');
            }
        });
        post.fail(function() {
            alert('Could not perform request!');
        });

        post.always(function() {
            doc.style.cursor = '';
        });  
    }

    function executeLinuxCli() {
        var ip = jQuery('#linuxIconIp').val();
        var pw = jQuery('#linuxIconPass').val();
        var cli = jQuery('#linuxCli').val();

        var doc = document.getElementsByTagName('html')[0];
        doc.style.cursor = 'progress';
        
        var url = '/ajax/executeLinuxCli/';
        var params = {
             'pw' : pw,
             'ip' : ip,
             'cli' : cli
        };
        var post = jQuery.post(url, params, function(response) {
            data = eval(response);
            if (data["result"] == false) {
                alert("Device is not yet booted up!");
                jQuery('#linuxCliOutput').val('error');
                jQuery('#linuxCliOutput').css("height", '');
            } else {
                jQuery('#linuxCliOutput').val(data['output']);
                jQuery('#linuxCliOutput').css("height", '300px');
            }
        });
        post.fail(function() {
            alert('Could not perform request!');
        });

        post.always(function() {
            doc.style.cursor = '';
        });  
    }

    /* UI related function */
    var currentSelection = "None";

    function deleteSelectedObject() {
        var so = jQuery('#selectedObject').val();
        if (so != 0) {
            var figure = canvas.getFigure(so);
            if (figure == null) {
                console.log('deleting line');
                figure  = canvas.getLine(so);
            } 
            if (figure.NAME == "draw2d.shape.node.externalCloudIcon") {
                externalCloudAdded = false;
            }
            canvas.removeFigure(figure);
            jQuery('#selectedObject').val("0");
        }
    }

    function hideAllEditors() {
        manuallyTogglePanel('jsonDebug', 'none');
        manuallyTogglePanel('junosIconEditor', 'none');
        manuallyTogglePanel('linuxIconEditor', 'none');
        manuallyTogglePanel('connectionEditor', 'none');
        manuallyTogglePanel('labelEditor', 'none');
    }

    function hideSelection() {
        hideAllEditors();
        currentSelection = "None";
    }
    
    function showDebug() {
        hideAllEditors();
        manuallyTogglePanel('jsonDebug', '');
        currentSelection = "debug";
	    exportJson();
	    jQuery('#debug').val("");
	    jQuery('#debug').val(jQuery('#json').val());
    }

    function showConfigSetEditor() {
        manuallyTogglePanel('configSetCreateForm', '');
        manuallyTogglePanel('configSetCreateRow', 'none');
    }

    function showTopoEditor() {
        manuallyTogglePanel('topoEditorForm', '');
        manuallyTogglePanel('topoInfo', 'none');
    }

    function importJson() {
        jQuery('#json').val(jQuery('#debug').val());
        loadTopology();
    }

    function setSelectedObject(objectId) {
        console.log(objectId);
        jQuery('#selectedObject').val(objectId);
    }

    function manuallyTogglePanel(el, v) {
        var sel = '#' + el;
        if(v == "none") {
            if(jQuery(sel).css("display") == 'none' || jQuery(sel).css("display") == undefined) {
                return;
            }
            jQuery(sel).css("display", "none");

        } else {
            jQuery(sel).css("display", "block");
        }
    }

    function loadJunosIconEditor(figureId) {

        console.log(figureId);
        //changed from selectedConnection ?
        jQuery('#selectedObject').val(figureId);
        var instance = canvas.getFigure(figureId);
        jQuery('#junosIconName').val(instance.getLabel());
        jQuery('#junosIconIp').val(instance.getIp());
        jQuery('#junosIconPass').val(instance.getPassword());
        jQuery('#junosIconCpu').val(instance.getCpu());
        jQuery('#junosIconRam').val(instance.getRam());

        // clear the cli output      
        jQuery('#cliOutput').val("");
        jQuery('#cliOutput').height("");
 
        var port = instance.getPorts().get(0);
        
        var connections = port.getConnections();

        jQuery('#junosIconNeighbors').html("");
        
        if (instance.getBootState() == "up") { 
            jQuery('#junosIconStatus').html("Ready");
        } else {
            jQuery('#junosIconStatus').html("Not Ready");
        }

        for (c=0;c<connections.size;c++) {
            var connection = connections.get(c);

            var sourcePort = connection.getSource();
            var targetPort = connection.getTarget();
           
            var neighbor = " ge-0/0/" + c; 

            if (sourcePort.getId() != port.getId()) {
                neighbor = neighbor + "   :   " + sourcePort.getParent().getLabel(); 
            } else {
                neighbor = neighbor + "   :   " + targetPort.getParent().getLabel(); 
            }

            jQuery('#junosIconNeighbors').html(jQuery('#junosIconNeighbors').html() + neighbor + "<br/>");

        }
        if (currentSelection !== "junosIconEditor") {
            hideAllEditors();
            manuallyTogglePanel('junosIconEditor', '');
            currentSelection = "junosIconEditor";
        }

    }

    function loadGenericIconEditor(figureId) {
        jQuery('#selectedObject').val(figureId);
        hideAllEditors();
        currentSelection = "genericIconEditor";
    }
    
    function loadLinuxIconEditor(figureId) {
        
        jQuery('#selectedObject').val(figureId);
        var instance = canvas.getFigure(figureId);

        // clear the cli output
        jQuery('#linuxCliOutput').val("");
        jQuery('#linuxCliOutput').height("");

        console.log(instance.getLabel());
        jQuery('#linuxIconName').val(instance.getLabel());
        jQuery('#linuxIconIp').val(instance.getIp());
        jQuery('#linuxIconPass').val(instance.getPassword());
        jQuery('#linuxIconCpu').val(instance.getCpu());
        jQuery('#linuxIconRam').val(instance.getRam());
        
        if (currentSelection !== "linuxIconEditor") {
            hideAllEditors();
            manuallyTogglePanel('linuxIconEditor', '');
            currentSelection = "linuxIconEditor";
        }
    }

    function updateJunosIcon() {
        var instance = canvas.getFigure(jQuery('#selectedObject').val());

        instance.setIp(jQuery('#junosIconIp').val());
        instance.setLabel(jQuery('#junosIconName').val());
        instance.setPassword(jQuery('#junosIconPass').val());

        instance.repaint();
        
    }

    function loadLabelEditor(figureId) {
        if (currentSelection !== "labelEditor") {
            hideAllEditors();
            manuallyTogglePanel('labelEditor', '');
            currentSelection = "labelEditor";
        }
        p = canvas.getFigure(figureId);
        jQuery('#selectedLabel').val(figureId);
        jQuery('#labelText').val(p.getText());
        jQuery('#labelFontSize').val(p.fontSize);
    }

    function updateLabel() {
        l = canvas.getFigure(jQuery('#selectedLabel').val());
        l.setText(jQuery('#labelText').val());
        l.setFontSize(jQuery('#labelFontSize').val());
    }

    // fixme - this will be broken for anything other than vmx
    function loadConnectionEditor(figureId) {
        var connection = canvas.getLine(figureId);
        var sourcePort = connection.getSource();
        var targetPort = connection.getTarget();

        targetConns = targetPort.getConnections();
        sourceConns = sourcePort.getConnections();

        var sourceIndex = 0;
        var targetIndex = 0;

        for(s=0;s<sourceConns.size;s++) {
            sc = sourceConns.get(s);
            console.log(sc.id);
            if(sc.id == figureId) {
                sourceIndex = s;
                break;
            }
        }
        
        for(t=0;t<targetConns.size;t++) {
            tc = targetConns.get(t);
            console.log(tc.id);
            if(tc.id == figureId) {
                targetIndex = t;
                break;
            }
        }
        // do the right this if we are connected to an external Bridge
        if (targetPort.getParent().NAME == "draw2d.shape.node.externalCloudIcon" ||
            targetPort.getParent().NAME == "draw2d.shape.node.internalCloudIcon") 
        {
            jQuery('#connectionTargetDevice').html(targetPort.getParent().getLabel());
            jQuery('#connectionTargetIp').val("0.0.0.0");
            jQuery('#connectionTargetType').val("cloud");
            jQuery('#connectionTargetPortIp').val("0.0.0.0");
            jQuery('#connectionTargetPortIp').prop("disabled", true);
        } else {
            var targetPortString = "ge-0/0/";
            if (targetPort.getParent().getType() == "linux") {
                targetPortString = "eth";    
            }
            jQuery('#connectionTargetDevice').html(targetPort.getParent().getLabel() + " " + targetPortString + targetIndex);
            jQuery('#connectionTargetIp').val(targetPort.getParent().getIp());
            jQuery('#connectionTargetType').val(targetPort.getParent().getType());
            jQuery('#connectionTargetPw').val(targetPort.getParent().getPassword());
            jQuery('#connectionTargetIface').val(targetPortString + targetIndex);
            jQuery('#connectionTargetPortIp').val("");
            jQuery('#connectionTargetPortIp').prop("disabled", false);
        }

        if (sourcePort.getParent().NAME == "draw2d.shape.node.externalCloudIcon" ||
            sourcePort.getParent().NAME == "draw2d.shape.node.internalCloudIcon") 
        {

            jQuery('#connectionSourceDevice').html(sourcePort.getParent().getLabel());
            jQuery('#connectionSourceIp').val("0.0.0.0");
            jQuery('#connectionSourceType').val("cloud");
            jQuery('#connectionSourcePortIp').val("0.0.0.0");
            jQuery('#connectionSourcePortIp').prop("disabled", true);
        } else {
            var sourcePortString = "ge-0/0/";
            if (sourcePort.getParent().getType() == "linux") {
                sourcePortString = "eth";    
            }
            jQuery('#connectionSourceDevice').html(sourcePort.getParent().getLabel() + " " + sourcePortString + sourceIndex);
            jQuery('#connectionSourceIp').val(sourcePort.getParent().getIp());
            jQuery('#connectionSourceType').val(sourcePort.getParent().getType());
            jQuery('#connectionSourcePw').val(sourcePort.getParent().getPassword());
            jQuery('#connectionSourceIface').val(sourcePortString + sourceIndex);
            jQuery('#connectionSourcePortIp').val("");
            jQuery('#connectionSourcePortIp').prop("disabled", false);
        }

        var connData = connection.getUserData();
        if (connData != null) {
            jQuery('#connectionSourcePortIp').val(connData["sourceIp"]);
            jQuery('#connectionTargetPortIp').val(connData["targetIp"]);
        }

        if (currentSelection !== "connectionEditor") {
            hideAllEditors();
            manuallyTogglePanel('connectionEditor', '');
            currentSelection = "connectionEditor";
        }

        jQuery('#selectedConnection').val(figureId);
    }

    function saveConnectionData() {
        var connId = jQuery('#selectedConnection').val();
        var sIp = jQuery('#connectionSourcePortIp').val();
        var tIp = jQuery('#connectionTargetPortIp').val();
        var connData = {
            "sourceIp": sIp,
            "targetIp": tIp
        };
        var connection = canvas.getLine(connId);
        connection.setUserData(connData);
        console.log("saved info on connection Object");
    }

    function addLabel() {
        var label = jQuery('#newLabel').val();
        var labelSize = jQuery('#newLabelFontSize').val();
        var l = new draw2d.shape.basic.Label(label);
        // l.setBackgroundColor();
        l.setFontColor("#000000");
        l.setFontSize(labelSize);
        l.setStroke("0");
        lastX += 50;
        lastY += 50;
        canvas.addFigure(l, lastX, lastY);
    }

    function addExternalCloud() {
        if (externalCloudAdded == false) {
            var c = new draw2d.shape.node.externalCloudIcon();
            canvas.addFigure(c, 385, 15);
            externalCloudAdded = true;
        } else {
            alert("You may only add one external connection!");
            return false;
        }
    }
    function addInternalCloud() {
        internalCloudCounter = internalCloudCounter + 1; 
        var c = new draw2d.shape.node.internalCloudIcon("Private " + internalCloudCounter);
        canvas.addFigure(c, 405 + (internalCloudCounter * 60), 15 + (internalCloudCounter * 50));
    }

    // are we editing an existing topology?
    function isNewTopology() {
        {% if topo_id != None %}
        return false;
        {% else %}
        return true;
        {% endif %}
    }

    jQuery( window ).load(function() {
        window.canvas = new draw2d.Canvas("gfx_holder", true);
	    canvas.installEditPolicy(new draw2d.policy.canvas.FadeoutDecorationPolicy());
        canvas.installEditPolicy(new draw2d.policy.canvas.SnapToGeometryEditPolicy(10));
        canvas.addSelectionListener(new topologySelectionListener());
        {% if topo.name != None %}
            loadTopology();
            {% if topo.id != 0 %}
                refreshDeploymentStatus( {{ topo.id }} );
                updateAllBootState();
            {% endif %}
        {% endif %}
    });
    </script>
{% endblock %}
{% block content %}
    <table border="0" style="border: 1px solid #000">
      <tr>
        <td id="topoFormContainer" style="vertical-align: top">
          <form method="post" id="topoForm" name="topoForm" 
            action="{% url 'topologies:create' %}" method="POST">
            {% csrf_token %}
            <table>
            {% if topo_id != None %}
             <tbody id="topoEditorForm" style="display: none">
            {% else %}
             <tbody id="topoEditorForm">
            {% endif %}
              <tr>
                <td>
                  Name
                </td>
                <td>
                  <input type="text" size="30" maxsize="30" name="name" id="name" value="{{ topo.name }}"/>
                  <input type="hidden" name="json" id="json" value="{{ topo.json }}"/>
                  <input type="hidden" id="selectedObject" value="0">
                </td>
              </tr>
              <tr>
                <td>
                  Description
                </td>
                <td>
                  <textarea rows="3" id="description" name="description">{{ topo.description }}</textarea>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  {% if topo_id != None %}
                  &nbsp;
                  <input type="hidden" name="id" id="topoId" value="{{ topo.id}}"/>
                  <input type="button" name="submit_button" id="submit_button" 
                    value="Update" onclick="javascript: updateTopology();"/>
                  {% else %}
                  <input type="button" name="submit_button" id="submit_button" 
                    value="Save" onclick="javascript: saveTopology();"/>
                  {% endif %}
                  <!--
                  <input type="button" name="debugButton" id="debugButton" 
                    value="Debug" onclick="javascript: showDebug();"/>
                  -->
                </td>
              </tr>
             </tbody>
            {% if topo_id != None %}
             <tbody id="topoInfo">
            {% else %}
             <tbody id="topoInfo" style="display: none">
            {% endif %}
              <tr>
                <th colspan="2">
                  Topology Details
                </th>
              </tr>
              <tr>
                <td>
                  Name:
                </td>
                <td>
                  {{ topo.name }}
                </td>
              </tr>
              <tr>
                <td>
                  Description:
                </td>
                <td>
                  {{ topo.description }}
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <input type="button" name="showTopoEditorButton" id="showTopoEditorButton" 
                    value="Edit" onclick="javascript: showTopoEditor();"/>
                  &nbsp;
                  <input type="button" name="delete_button" id="delete_button" 
                    value="Delete" onclick="javascript: deleteTopology();"/>
                  &nbsp;
                  <input type="button" name="clone_button" id="clone_button" 
                    value="Clone" onclick="javascript: cloneTopology();"/>
                  &nbsp;
                  &nbsp;
                  <input type="button" name="multi_clone_button" id="multi_clone_button" 
                    value="Multiple Clones" onclick="javascript: multiCloneTopology();"/>
                  &nbsp;
                </td>
              </tr>
             </tbody>
            </table>
          </form>
          {% if topo_id != None %}
          <div id="addInstanceForm" style="display: none">
          {% else %}
          <div id="addInstanceForm">
          {% endif %}
            <br/>
            <h3>Add Instance</h3>
            <table>
              <tr>
                <td>
                  IP Address
                </td>
                <td>
                  <input type="text" size="15" maxsize="15" name="topoIconIp" id="topoIconIp" value=""/>
                </td>
              </tr>
              <tr>
                <td>
                  Root Password
                </td>
                <td>
                  <input type="text" size="15" maxsize="15"
                    name="topoIconPass" id="topoIconPass" value="" 
                    onblur="javascript: checkPass(this.value);"/> 
                </td>
              </tr>
              <tr>
                <td>
                  Instance Name
                </td>
                <td>
                  <input type="text" size="15" maxsize="15" name="topoIconName" id="topoIconName" value=""/>
                </td>
              </tr>
              <tr>
                <td>
                  Base Image
                </td>
                <td>
                  <select name="topoIconImageSelect" id="topoIconImageSelect" onchange="javascript: setImageType();">
                    <option value="0">Choose Image</option>
                    <!-- not a better way to do this? -->
                    {% for i in image_list %}
                    <option value="{{ i.id }}:{{i.type}}">{{ i.name }}</option>
                    {% endfor %}
                  </select>
                  <input type="hidden" name="topoIconType" id="topoIconType" value=""/>
                  <input type="hidden" name="topoIconImage" id="topoIconImage" value=""/>
                </td>
              </tr>
              <tr>
                <td>
                  vCPU
                </td>
                <td>
                  <select name="topoIconCpu" id="topoIconCpu">
                    <option value="1">1</option>
                    <option value="2" selected>2</option>
                    <option value="4">4</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>
                  vRAM
                </td>
                <td>
                  <select name="topoIconRam" id="topoIconRam">
                    <option value="512">512</option>
                    <option value="768">768</option>
                    <option value="1024">1024</option>
                    <option value="2048" selected>2048</option>
                    <option value="4096">4096</option>
                    <option value="8192">8192</option>
                    <option value="16384">16384</option>
                  </select> MB
                </td>
              </tr>
              <tr>
                <td>
                  Icon
                </td>
                <td>
                  <select name="topoIconIcon" id="topoIconIcon">
                    <option value="mx_large:50:60">MX Large</option>
                    <option value="mx_small:50:40">MX Small</option>
                    <option value="firefly:40:40">Firefly</option>
                    <option value="router:40:40">Generic Router</option>
                    <option value="server:25:50">Generic Server</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <input type="button" onclick="javascript: addIcon();" value="Add Instance"/>
                </td>
              </tr>
            </table>
            <br/>
            <h3>Add Object</h3>
            <table>
              <tr>
                <td>
                  External Access:
                </td>
                <td>
                  <input type="button" value="Add External Bridge" title="Add br0" onclick="javascript: addExternalCloud()"/>
                </td>
              </tr>
              <tr>
                <td>
                  Private Network:
                </td>
                <td>
                  <input type="button" value="Add Private Bridge" title="Add int_br0" onclick="javascript: addInternalCloud()"/>
                </td>
              </tr>
            </table>
            <br/>
            <h3>Add Label</h3>
            <table>
              <tr>
                <td>
                  Text:
                </td>
                <td>
                  <input type="text" id="newLabel"/>
                </td>
              </tr>
              <tr>
                <td>
                  Font Size:
                </td>
                <td>
                  <select id="newLabelFontSize">
                    <option value="8">8</option>
                    <option value="10">10</option>
                    <option value="12">12</option>
                    <option value="14">14</option>
                    <option value="16" selected>16</option>
                    <option value="18">18</option>
                    <option value="20">20</option>
                    <option value="22">22</option>
                    <option value="24">24</option>
                    <option value="26">26</option>
                    <option value="28">28</option>
                    <option value="30">30</option>
                    <option value="40">40</option>
                    <option value="48">48</option>
                  </select>
                </td>
                </tr>
              <tr>
                <td colspan="2">
                  <input type="button" value="Add Label" onclick="javascript: addLabel()"/>
                </td>
              </tr>
            </table>
            <br/>
            <h3>Tools</h3>
            <table>
              <tr>
                <td>
                  Delete Object:
                </td>
                <td>
                  <input type="button" value="Delete" title="Remove selected Object from Topology" onclick="javascript: deleteSelectedObject()"/>
                </td>
              </tr>
            </table>
          </div>
          <div id="linuxIconEditor" style="display:none">
            <table>
              <th colspan="2">
                 Instance Details
              </th>
              <tr>
                <td>
                   Name
                </td>
                <td>
                  <input type="text" disabled="true" name="linuxIconName" id="linuxIconName" value=""/>
                </td>
              </tr>
              <tr>
                <td>
                   IP Address
                </td>
                <td>
                  <input type="text" disabled="true" title="management address" name="linuxIconIp" id="linuxIconIp" value=""/>
                </td>
              </tr>
              <tr>
                <td>
                   Root Password
                </td>
                <td>
                  <input type="text" disabled="true"
                    name="linuxIconPass" id="linuxIconPass" value=""/>
                </td>
              </tr>
              <tr>
                <td>
                   vCPU
                </td>
                <td>
                  <input type="text" disabled="true"
                    name="linuxIconCPU" id="linuxIconCpu" value="2"/>
                </td>
              </tr>
              <tr>
                <td>
                  vRAM
                </td>
                <td>
                  <input type="text" disabled="true"
                    name="linuxIconRam" id="linuxIconRam" value="2"/>
                </td>
              </tr>
            </table>
            <table>
              <th colspan="2">
                 Execute cli
              </th>
              <tr>
                <td>
                  <input type="text" id="linuxCli" value="cat /proc/loadavg"/>
                </td>
                <td>
                  <input type="button" onclick="javascript: executeLinuxCli();" value="Go">
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <textarea id="linuxCliOutput" rows="1"></textarea>
                </td>
              </tr>
            </table>
            <table>
              <th colspan="2">
                 Automation Tools
              </th>
              <tr>
                <td>
                  Instance Configuration
                </td>
                <td>
                  <input type="button" onclick="javascript: getInstanceStartupState();" value="Refresh Boot State" title="Determines if the instance is fully booted and ready">
                    <br/>
                    <br/>
                  <input type="button" onclick="javascript: configureInstanceAccess();" value="Configure Access" title="Configures Management IP Address">
                    <br/>
                    <br/>
                </td>
              </tr>
            </table>

          </div>
          <div id="junosIconEditor" style="display:none">
            <table>
              <th colspan="2">
                 Instance Details
              </th>
              <tr>
                <td>
                   Name
                </td>
                <td>
                  <input type="text" disabled="true" name="junosIconName" id="junosIconName" value=""/>
                </td>
              </tr>
              <tr>
                <td>
                   IP Address
                </td>
                <td>
                  <input type="text" disabled="true" title="management address" name="junosIconIp" id="junosIconIp" value=""/>
                </td>
              </tr>
              <tr>
                <td>
                   Root Password
                </td>
                <td>
                  <input type="text" disabled="true"
                    name="junosIconPass" id="junosIconPass" value=""/>
                </td>
              </tr>
              <tr>
                <td>
                   vCPU
                </td>
                <td>
                  <input type="text" disabled="true"
                    name="junosIconCPU" id="junosIconCpu" value="2"/>
                </td>   
              </tr>
              <tr>
                <td>
                  vRAM 
                </td>
                <td>
                  <input type="text" disabled="true"
                    name="junosIconRam" id="junosIconRam" value="2"/>
                </td>   
              </tr>
              <tr>
                <td>
                  Neighbors
                </td>
                <td>
                  <div id="junosIconNeighbors"></div>
                </td>
              </tr>
              <tr>
                <td>
                  Bootup Status
                </td>
                <td>
                  <div id="junosIconStatus"></div>
                </td>
              </tr>
            </table>
            <table>
              <th colspan="2">
                 Automation Tools
              </th>
              <tr>
                <td>
                  Instance Configuration
                </td>
                <td>
                  <input type="button" onclick="javascript: getInstanceStartupState();" value="Refresh Boot State" title="Determines if the instance is fully booted and ready"> 
                    <br/>
                    <br/>
                  <input type="button" onclick="javascript: configureInstanceAccess();" value="Configure Access" title="Configures SSH + Netconf"> 
                    <br/>
                    <br/>
                  <input type="button" onclick="javascript: configureJunosInterfaces();" value="Configure Interfaces" title="Configures ge-0/0/X interfaces with the required MAC addresses">
                    <br/>
                    <br/>
                  <input type="button" onclick="javascript: loadConfigTemplates();" value="Load Configuration Templates" title="Select a configuration template to push to the device"/>
                </td>
              </tr>
            </table>
            <table>
              <th colspan="2">
                 Execute cli
              </th>
              <tr>
                <td>
                  <input type="text" id="cli" value="show interface terse"/>
                </td>
                <td>
                  <input type="button" onclick="javascript: executeCli();" value="Go">
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <textarea id="cliOutput" rows="1"></textarea>
                </td>
              </tr>
            </table>
          </div>
          <div id="labelEditor" style="display: none;">
            <table>
              <th colspan="2">
                 Edit Label
              </th>
              <tr>
                <td>
                  <input type="hidden" id="selectedLabel" value="0">
                  Text: 
                </td>
                <td>
                  <input type="text" id="labelText" value="na">
               </td>
             </tr>
             <tr>
               <td>
                Size:
                </td>
                <td>
                  <select id="labelFontSize">
                    <option value="8">8</option>
                    <option value="10" selected>10</option>
                    <option value="12">12</option>
                    <option value="14">14</option>
                    <option value="16">16</option>
                    <option value="18">18</option>
                    <option value="20">20</option>
                    <option value="22">22</option>
                    <option value="24">24</option>
                    <option value="26">26</option>
                    <option value="28">28</option>
                    <option value="30">30</option>
                    <option value="40">40</option>
                    <option value="48">48</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <input type="button" value="Update" onclick="javascript: updateLabel();"/>
                </td>
              </tr>
            </table>
          </div>
          <div id="connectionEditor" style="display: none;">
            <table>
              <th colspan="2">
                 Edit Connection
              </th>
              <tr>
                <td colspan="2">
                  <input type="hidden" id="selectedConnection" value="0">
                  <input type="hidden" id="connectionSourceIp" value="0">
                  <input type="hidden" id="connectionSourceType" value="0">
                  <input type="hidden" id="connectionTargetIp" value="0">
                  <input type="hidden" id="connectionTargetType" value="0">
                  <input type="hidden" id="connectionSourceIface" value="0">
                  <input type="hidden" id="connectionTargetIface" value="0">
                  <input type="hidden" id="connectionSourcePw" value="0">
                  <input type="hidden" id="connectionTargetPw" value="0">
                </td>
              </tr>
              <tr>
                <td>
                  Source Device:
                </td>
                <td>
                  <div style="display: inline;" id="connectionSourceDevice"></div>
                </td>
              </tr>
              <tr>
                <td>
                  Source IP Address:
                </td>
                <td>
                  <input type="text" onblur="javascript: saveConnectionData();"  id="connectionSourcePortIp">
                </td>
              </tr>
              <tr>
                <td>
                  Target Device:
                </td>
                <td>
                  <div style="display: inline;" id="connectionTargetDevice"></div>
                </td>
              </tr>
              <tr>
                <td>
                  Target IP Address:
                </td>
                <td>
                  <input type="text" onblur="javascript: saveConnectionData();" id="connectionTargetPortIp">
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <input type="button" onclick="javascript: syncLinkData();" value="Sync IP Addresses" title="Push IP information to devices for this connection">
                </td>
              </tr>
            </table>
          </div>
          <div id="jsonDebug" style="display: none;">
            <table>
              <th>
                 Debug Panel
              </th>
              <tr>
                <td>
                  <textarea id="debug" cols="1" rows="5"></textarea>
                </td>
              </tr>
            </table>
          </div>
          <div id="deploymentStatus"></div>
          {% if topo_id != None %}
          <div id="configSets">
            <form method="post" id="configSetForm" name="configSetForm" action="{% url 'topologies:createConfigSet' %}" method="POST">
            {% csrf_token %}
            <table>
              <tbody id="configSetCreateForm" style="display: none">
              <tr>
                <th colspan="3">
                  Config Sets
                </th>
              </tr>
              <tr>
                <td>
                  Name
                </td>
                <td colspan="2">
                  <input type="text" size="30" maxsize="30" name="name" id="configSetName" value="New Config Set"/>
                  <!-- <input type="hidden" id="selectedObject" value="0"> -->
                </td>
              </tr>
              <tr>
                <td>
                  Description
                </td>
                <td colspan="2">
                  <textarea rows="3" id="configSetDescription" name="description">Base Config</textarea>
                </td>
              </tr>
              <tr>
                <td colspan="3">
                  <input type="hidden" name="topoId" id="configSetTopoId" value="{{ topo.id}}"/>
                  <input type="button" name="configSet_create_button" id="configSet_create_button"
                    value="Save" onclick="javascript: createConfigSet();"/>
                </td>
              </tr>
              </tbody>
              <tbody>
              <tr>
                <th colspan="3"> Saved Config Sets </th>
              </tr>
              {% for c in configSets %}
              <tr>
                <td>
                  {{ c.name }} 
                </td>
                <td>
                  {{ c.description}} 
                </td>
                <td>
                  <a href="#" onclick="javascript: pushConfigSet({{ c.id }})">Push</a>
                  &nbsp;
                  <a href="#" onclick="javascript: deleteConfigSet({{ c.id }})">Delete</a>
                </td>
              </tr>
              {% endfor %}
              </tbody>
              <tbody id="configSetCreateRow">
                <tr>
                  <td colspan="3">
                    <input type="button" name="configSet_editor_button" id="configSet_editor_button"
                    value="Create" onclick="javascript: showConfigSetEditor();"/>
                  </td>
                 </tr>
              </tbody>
            </table>
            </form>
          </div>
          {% endif %}
        </td>
        <td style="vertical-align: top">
          <div id="gfx_holder" style="background-image: url({% static 'images/grid.png' %});
            background-repeat: repeat; 
            width:900px; 
            height:650px; 
            position:relative; 
            border: 1px solid #000">
          </div>
          <div id="jsonLayout" style="display: none;">{{ topology.json }}</div>
          <div id="toolsMenu" style="width: 900px; padding-top: 4px;">
          </div>
        </td>
      </tr>
    </table>
{% endblock %}
